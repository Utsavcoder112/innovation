<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Annadan - View All Foods</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <link rel="stylesheet" href="./viewfood.css">  
    <link rel="stylesheet" href="./request.css">
    <link rel="stylesheet" href="./save-request.css">
    <style>
        /* Reset & Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                Annadan
            </div>
            <div class="sidebar-menu">
                <div class="menu-item">
                    <a href="./Donar/donar.html"><i class="fas fa-home"></i> Dashboard</a>
                </div>
                
                <div class="menu-item dropdown">
                    <a href="#" class="dropdown-toggle"><i class="fas fa-list"></i> Food Management</a>
                    <div class="dropdown-menu">
                        <a href="./form.html">Add Food</a>
                        <a href="#">Manage Listings</a>
                        <a href="#">Food History</a>
                    </div>
                </div>
                
                <div class="menu-item dropdown">
                    <a href="#" class="dropdown-toggle"><i class="fas fa-hand-holding-heart"></i> Requests</a>
                    <div class="dropdown-menu">
                        <a href="./request.html">New Requests</a>
                        <a href="#">Completed</a>
                        <a href="#">Rejected</a>
                        <a href="#">All Requests</a>
                    </div>
                </div>
                
                <div class="menu-item">
                    <a href="#"><i class="fas fa-chart-bar"></i> Analytics</a>
                </div>
                
                <div class="menu-item">
                    <a href="#"><i class="fas fa-cog"></i> Settings</a>
                </div>
            </div>
            
            <div class="action-buttons">
                <a href="#" class="action-btn donate-btn"><i class="fas fa-plus-circle"></i> Donate Food</a>
                <a href="#" class="action-btn request-btn"><i class="fas fa-hand-holding"></i> Request Food</a>
                <a href="#" class="action-btn view-btn"><i class="fas fa-list-alt"></i> View All Foods</a>
            </div>
            
            <div class="search-box">
                <input type="text" id="search-input" placeholder="Search foods...">
            </div>
            
            <div class="user-profile">
                <div class="user-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="user-info">
                    <div class="user-name" id="userName">Loading...</div>
                    <div class="user-role">Food Provider</div>
                </div>
                <i class="fas fa-ellipsis-v" style="color: rgba(255, 255, 255, 0.5); cursor: pointer;"></i>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Navbar -->
            <header class="navbar">
                <div class="page-title">Available Food Donations</div>
                <div class="navbar-right">
                    <ul>
                        <li><a href="./home.html">Home</a></li>
                        <li><a href="#">About Us</a></li>
                        <li><a href="#">How It Works</a></li>
                        <li><a href="#">Contact</a></li>
                        <li><a href="#">FAQ</a></li>
                    </ul>
                    <div class="notification-icon">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge" id="notificationBadge">3</span>
                    </div>
                    <button id="logoutBtn" class="logout-btn" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </header>

            <!-- Foods Container -->
            <div class="foods-container">
                <div class="foods-header">
                    <h1>Available Food Donations</h1>
                    <div class="filters">
                        <button class="filter-btn active" data-filter="all">
                            <i class="fas fa-list"></i> All
                        </button>
                        <button class="filter-btn" data-filter="expiring">
                            <i class="fas fa-clock"></i> Expiring Soon
                        </button>
                        <button class="filter-btn" data-filter="recent">
                            <i class="fas fa-plus-circle"></i> Recently Added
                        </button>
                        <button class="filter-btn" data-filter="my-donations">
                            <i class="fas fa-user"></i> My Donations
                        </button>
                    </div>
                </div>
                
                <!-- Loading Spinner -->
                <div id="loader" class="loader"></div>
                
                <!-- Error Message -->
                <div id="errorMessage" class="error-message" style="display:none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>Unable to load donations</h3>
                    <p id="errorText">Please try again later.</p>
                    <button onclick="loadFoodDonations()" class="retry-btn">Retry</button>
                </div>
                
                <!-- Food Listings -->
                <div id="foodListings" class="food-listings">
                    <!-- Food cards will be injected here by JavaScript -->
                </div>
                
                <!-- Empty State (shown when no results) -->
                <div id="emptyState" class="empty-state" style="display:none;">
                    <i class="fas fa-box-open"></i>
                    <h3>No food donations available</h3>
                    <p>There are currently no food donations available. Check back later or donate some food yourself!</p>
                </div>
                
                <!-- Pagination -->
                <div class="pagination" id="pagination">
                    <!-- Pagination buttons will be added dynamically -->
                </div>
            </div>

            <!-- Footer -->
            <footer>
                <div class="footer-content">
                    <div class="footer-logo">Annadan</div>
                    <div class="footer-links">
                        <a href="#">About</a>
                        <a href="#">Our Mission</a>
                        <a href="#">How It Works</a>
                        <a href="#">Contact</a>
                        <a href="#">Privacy Policy</a>
                        <a href="#">Terms of Service</a>
                    </div>
                    <div class="social-links">
                        <a href="#"><i class="fab fa-facebook"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-linkedin"></i></a>
                    </div>
                </div>
            </footer>
        </main>
    </div>
    
    <!-- Food Details Modal -->
    <div id="foodModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Food Donation Details</div>
                <span class="close-modal" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="donation-image" id="modalImage">
                    <!-- Image will be inserted here -->
                </div>
                <div class="donation-details">
                    <div class="detail-row">
                        <div class="detail-label">Donated by:</div>
                        <div class="detail-value" id="modalDonor">Loading...</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Pickup Address:</div>
                        <div class="detail-value" id="modalAddress">Loading...</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Pickup Date:</div>
                        <div class="detail-value" id="modalPickupDate">Loading...</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Pickup Time:</div>
                        <div class="detail-value" id="modalPickupTime">Loading...</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Expires On:</div>
                        <div class="detail-value" id="modalExpiryDate">Loading...</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Description:</div>
                        <div class="detail-value" id="modalDescription">Loading...</div>
                    </div>
                </div>
                
                <div class="food-items-list">
                    <h3>Food Items</h3>
                    <table class="food-items-table">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Quantity</th>
                                <th>Unit</th>
                            </tr>
                        </thead>
                        <tbody id="modalFoodItems">
                            <!-- Food items will be injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="contact-btn email-btn" id="modalEmailBtn">
                    <i class="fas fa-envelope"></i> Email Donor
                </button>
                <button class="contact-btn phone-btn" id="modalPhoneBtn">
                    <i class="fas fa-phone"></i> Call Donor
                </button>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Login Required</div>
            </div>
            <div class="modal-body">
                <p>Please log in to view food donations.</p>
                <div class="login-form">
                    <div class="form-group">
                        <label for="loginEmail">Email:</label>
                        <input type="email" id="loginEmail" class="form-input" placeholder="Enter your email">
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password:</label>
                        <input type="password" id="loginPassword" class="form-input" placeholder="Enter your password">
                    </div>
                    <div id="loginError" class="error-text" style="display:none;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="login-btn" onclick="performLogin()">Login</button>
            </div>
        </div>
    </div>
</body>
<script>
// Configuration
const API_BASE_URL = 'http://127.0.0.1:8000';


// Global variables
let allDonations = [];
let currentFilter = 'all';
let currentPage = 1;
const itemsPerPage = 9;
let currentUser = null;

// Authentication helper functions
function getAuthToken() {
    return localStorage.getItem('access_token');
}

function setAuthToken(token) {
    localStorage.setItem('access_token', token);
}

function removeAuthToken() {
    localStorage.removeItem('access_token');
}

function isAuthenticated() {
    return !!getAuthToken();
}

// API helper function
async function apiCall(url, options = {}) {
    const token = getAuthToken();
    
    const defaultOptions = {
        headers: {
            'Content-Type': 'application/json',
            ...(token && { 'Authorization': `Bearer ${token}` })
        }
    };
    
    const finalOptions = {
        ...defaultOptions,
        ...options,
        headers: {
            ...defaultOptions.headers,
            ...options.headers
        }
    };
    
    try {
        const response = await fetch(url, finalOptions);
        
        if (response.status === 401) {
            // Token expired or invalid
            removeAuthToken();
            showLoginModal();
            throw new Error('Authentication required');
        }
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ detail: 'Unknown error' }));
            throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
        }
        
        return await response.json();
    } catch (error) {
        console.error('API call error:', error);
        throw error;
    }
}

// Authentication functions
async function performLogin() {
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    const errorDiv = document.getElementById('loginError');
    
    if (!email || !password) {
        errorDiv.textContent = 'Please enter both email and password';
        errorDiv.style.display = 'block';
        return;
    }
    
    try {
        // Prepare form data for OAuth2 format
        const formData = new FormData();
        formData.append('username', email);
        formData.append('password', password);
        
        const response = await fetch(`${API_BASE_URL}/login`, {
            method: 'POST',
            body: formData
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Login failed');
        }
        
        const data = await response.json();
        setAuthToken(data.access_token);
        
        // Hide login modal
        document.getElementById('loginModal').style.display = 'none';
        
        // Load user info and donations
        await loadUserInfo();
        await loadFoodDonations();
        
    } catch (error) {
        console.error('Login error:', error);
        errorDiv.textContent = error.message;
        errorDiv.style.display = 'block';
    }
}

async function loadUserInfo() {
    try {
        const user = await apiCall(`${API_BASE_URL}/user/me`);
        currentUser = user;
        document.getElementById('userName').textContent = user.full_name;
    } catch (error) {
        console.error('Error loading user info:', error);
    }
}

function logout() {
    removeAuthToken();
    currentUser = null;
    document.getElementById('userName').textContent = 'Guest';
    showLoginModal();
}

function showLoginModal() {
    document.getElementById('loginModal').style.display = 'block';
    document.getElementById('loginError').style.display = 'none';
}

// When document is ready
document.addEventListener('DOMContentLoaded', function() {
    // Check if user is authenticated
    if (!isAuthenticated()) {
        showLoginModal();
    } else {
        loadUserInfo();
        loadFoodDonations();
    }
    
    // Add event listeners for filter buttons
    document.querySelectorAll('.filter-btn').forEach(button => {
        button.addEventListener('click', function() {
            // Remove active class from all buttons
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            // Add active class to clicked button
            this.classList.add('active');
            
            // Set current filter
            currentFilter = this.dataset.filter;
            
            // Reset pagination
            currentPage = 1;
            
            // Apply filter and update display
            filterAndDisplayDonations();
        });
    });
    
    // Add event listener for search input
    document.getElementById('search-input').addEventListener('input', function() {
        filterAndDisplayDonations();
    });
    
    // Add enter key listener for login form
    document.getElementById('loginPassword').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            performLogin();
        }
    });
});

// Fetch all food donations from the API
async function loadFoodDonations() {
    if (!isAuthenticated()) {
        showLoginModal();
        return;
    }
    
    // Show loader and hide other elements
    document.getElementById('loader').style.display = 'block';
    document.getElementById('foodListings').style.display = 'none';
    document.getElementById('emptyState').style.display = 'none';
    document.getElementById('errorMessage').style.display = 'none';
    
    try {
        // Determine API endpoint based on current filter
        let endpoint = `${API_BASE_URL}/api/donations/`;
        const queryParams = new URLSearchParams();
        
        if (currentFilter === 'my-donations') {
            queryParams.append('my_donations', 'true');
        }
        
        if (queryParams.toString()) {
            endpoint += '?' + queryParams.toString();
        }
        
        const data = await apiCall(endpoint);
        allDonations = data;
        
        // Filter and display donations
        filterAndDisplayDonations();
        
    } catch (error) {
        console.error('Error fetching donations:', error);
        document.getElementById('errorText').textContent = error.message;
        document.getElementById('errorMessage').style.display = 'flex';
    } finally {
        // Hide loader
        document.getElementById('loader').style.display = 'none';
        document.getElementById('foodListings').style.display = 'grid';
    }
}

// Filter and display donations based on current filter and search
function filterAndDisplayDonations() {
    const searchTerm = document.getElementById('search-input').value.toLowerCase();
    
    // Filter donations based on search term and current filter
    let filteredDonations = allDonations.filter(donation => {
        // Search filter
        const matchesSearch = 
            donation.title.toLowerCase().includes(searchTerm) ||
            donation.description.toLowerCase().includes(searchTerm) ||
            donation.items.some(item => item.name.toLowerCase().includes(searchTerm));
            
        // Additional filters
        let matchesFilter = true;
        
        if (currentFilter === 'expiring') {
            // Filter for donations expiring within 2 days
            const expiryDate = new Date(donation.expiry_date);
            const now = new Date();
            const twoDaysFromNow = new Date();
            twoDaysFromNow.setDate(now.getDate() + 2);
            matchesFilter = expiryDate <= twoDaysFromNow;
        } else if (currentFilter === 'recent') {
            // Filter for donations added in the last 24 hours
            const createdAt = new Date(donation.created_at);
            const now = new Date();
            const oneDayAgo = new Date();
            oneDayAgo.setDate(now.getDate() - 1);
            matchesFilter = createdAt >= oneDayAgo;
        } else if (currentFilter === 'my-donations') {
            // This filter is handled by the API call, so all returned donations match
            matchesFilter = true;
        }
        
        return matchesSearch && matchesFilter;
    });
    
    // Sort donations (most recent first)
    filteredDonations.sort((a, b) => {
        return new Date(b.created_at) - new Date(a.created_at);
    });
    
    // Paginate donations
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const paginatedDonations = filteredDonations.slice(startIndex, endIndex);
    
    // Display donations
    displayDonations(paginatedDonations, filteredDonations.length);
    
    // Create pagination
    createPagination(filteredDonations.length);
}

// Display the donations in the UI
function displayDonations(donations, totalCount) {
    const foodListings = document.getElementById('foodListings');
    const emptyState = document.getElementById('emptyState');
    
    // Clear existing content
    foodListings.innerHTML = '';
    
    if (donations.length === 0) {
        // Show empty state if no donations
        emptyState.style.display = 'flex';
        foodListings.style.display = 'none';
    } else {
        // Hide empty state and show donations
        emptyState.style.display = 'none';
        foodListings.style.display = 'grid';
        
        // Create cards for each donation
        donations.forEach(donation => {
            const card = createDonationCard(donation);
            foodListings.appendChild(card);
        });
    }
}

// Create a donation card element
function createDonationCard(donation) {
    // Calculate days until expiry
    const expiryDate = new Date(donation.expiry_date);
    const now = new Date();
    const daysUntilExpiry = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));
    let expiryText, expiryClass;
    
    if (daysUntilExpiry < 0) {
        expiryText = 'Expired';
        expiryClass = 'expired';
    } else if (daysUntilExpiry === 0) {
        expiryText = 'Expires Today';
        expiryClass = 'expiring-today';
    } else if (daysUntilExpiry === 1) {
        expiryText = 'Expires Tomorrow';
        expiryClass = 'expiring-soon';
    } else {
        expiryText = `Expires in ${daysUntilExpiry} days`;
        expiryClass = daysUntilExpiry <= 2 ? 'expiring-soon' : '';
    }
    
    // Create card element
    const card = document.createElement('div');
    card.className = `food-card ${expiryClass}`;
    card.dataset.id = donation.id;
    
    // Card image
    let imageHtml = '';
    if (donation.image_path) {
        const imageUrl = donation.image_path.startsWith('http') ? 
            donation.image_path : 
            `${API_BASE_URL}${donation.image_path}`;
        imageHtml = `<img src="${imageUrl}" alt="${donation.title}" onerror="this.parentElement.innerHTML='<div class=\\'no-image\\'><i class=\\'fas fa-utensils\\'></i></div>'" />`;
    } else {
        // Use a placeholder if no image
        imageHtml = `<div class="no-image">
            <i class="fas fa-utensils"></i>
        </div>`;
    }
    
    // Get first 2 food items (if available)
    let itemsHtml = '';
    if (donation.items && donation.items.length > 0) {
        const displayItems = donation.items.slice(0, 2);
        itemsHtml = displayItems.map(item => 
            `<div class="food-quantity">
                <span>${item.quantity} ${item.unit}</span> ${item.name}
            </div>`
        ).join('');
        
        if (donation.items.length > 2) {
            itemsHtml += `<div class="food-quantity">+${donation.items.length - 2} more items</div>`;
        }
    }
    
    // Format pickup date
    const pickupDate = new Date(donation.pickup_date);
    const formattedPickupDate = pickupDate.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric'
    });
    
    // Check if this is the current user's donation
    const isMyDonation = currentUser && donation.user_id === currentUser.id;
    
    // Build card HTML
    card.innerHTML = `
        <div class="food-image">
            ${imageHtml}
            <div class="expiry-tag ${expiryClass}">${expiryText}</div>
            ${isMyDonation ? '<div class="my-donation-tag">My Donation</div>' : ''}
        </div>
        <div class="food-info">
            <h3 class="food-title">${donation.title}</h3>
            <div class="food-items">
                ${itemsHtml}
            </div>
            <div class="food-meta">
                <div class="meta-item">
                    <i class="fas fa-map-marker-alt"></i> 
                    ${donation.pickup_address.split(',')[0]}
                </div>
                <div class="meta-item">
                    <i class="fas fa-calendar"></i> ${formattedPickupDate}
                </div>
                <div class="meta-item">
                    <i class="fas fa-user"></i> ${donation.donor_name || 'Anonymous'}
                </div>
            </div>
            <button class="view-details-btn" onclick="openDonationDetails('${donation.id}')">View Details</button>
            ${!isMyDonation ? `<button class="request-btn" onclick="showRequestConfirmation('${donation.id}')">Request</button>` : ''}
            ${isMyDonation ? `<button class="delete-btn" onclick="deleteDonation('${donation.id}')">Delete</button>` : ''}
        </div>
    `;
    
    return card;
}

// Open the donation details modal
function openDonationDetails(donationId) {
    const donation = allDonations.find(d => d.id === donationId);
    
    if (!donation) {
        console.error('Donation not found:', donationId);
        return;
    }
    
    // Fill modal with donation details
    document.getElementById('modalTitle').textContent = donation.title;
    document.getElementById('modalDescription').textContent = donation.description;
    document.getElementById('modalAddress').textContent = donation.pickup_address;
    document.getElementById('modalDonor').textContent = donation.donor_name || 'Anonymous';
    
    // Add image to modal
    const modalImage = document.getElementById('modalImage');
    if (donation.image_path) {
        const imageUrl = donation.image_path.startsWith('http') ? 
            donation.image_path : 
            `${API_BASE_URL}${donation.image_path}`;
        modalImage.innerHTML = `<img src="${imageUrl}" alt="${donation.title}" style="max-width: 100%; height: auto; border-radius: 8px;" />`;
    } else {
        modalImage.innerHTML = '';
    }
    
    // Format dates
    const pickupDate = new Date(donation.pickup_date);
    document.getElementById('modalPickupDate').textContent = pickupDate.toLocaleDateString('en-US', {
        weekday: 'long',
        month: 'long',
        day: 'numeric',
        year: 'numeric'
    });
    
    const expiryDate = new Date(donation.expiry_date);
    document.getElementById('modalExpiryDate').textContent = expiryDate.toLocaleDateString('en-US', {
        weekday: 'long',
        month: 'long',
        day: 'numeric',
        year: 'numeric'
    });
    
    // Pickup time window
    let pickupTimeText = '';
    switch(donation.pickup_time) {
        case 'morning':
            pickupTimeText = 'Morning (8AM - 12PM)';
            break;
        case 'afternoon':
            pickupTimeText = 'Afternoon (12PM - 4PM)';
            break;
        case 'evening':
            pickupTimeText = 'Evening (4PM - 8PM)';
            break;
        case 'anytime':
            pickupTimeText = 'Anytime (Flexible)';
            break;  
        default:
            pickupTimeText = donation.pickup_time;
    }
    document.getElementById('modalPickupTime').textContent = pickupTimeText;
    
    // Add food items to table
    const foodItemsTable = document.getElementById('modalFoodItems');
    foodItemsTable.innerHTML = '';
    
    donation.items.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${item.name}</td>
            <td>${item.quantity}</td>
            <td>${item.unit}</td>
        `;
        foodItemsTable.appendChild(row);
    });
    
    // Set contact buttons
    document.getElementById('modalEmailBtn').onclick = function() {
        window.location.href = `mailto:${donation.contact_email}?subject=Interested in your food donation: ${donation.title}`;
    };
    
    document.getElementById('modalPhoneBtn').onclick = function() {
        window.location.href = `tel:${donation.contact_phone}`;
    };
    
    // Show the modal
    document.getElementById('foodModal').style.display = 'block';
}

// Close the donation details modal
function closeModal() {
    document.getElementById('foodModal').style.display = 'none';
}

// Delete donation function
async function deleteDonation(donationId) {
    if (!confirm('Are you sure you want to delete this donation?')) {
        return;
    }
    
    try {
        await apiCall(`${API_BASE_URL}/api/donations/${donationId}`, {
            method: 'DELETE'
        });
        
        // Remove from local array and refresh display
        allDonations = allDonations.filter(d => d.id !== donationId);
        filterAndDisplayDonations();
        
        alert('Donation deleted successfully');
    } catch (error) {
        console.error('Error deleting donation:', error);
        alert('Failed to delete donation: ' + error.message);
    }
}

// Show request confirmation dialog
function showRequestConfirmation(donationId) {
    const donation = allDonations.find(d => d.id === donationId);
    
    if (!donation) {
        console.error('Donation not found:', donationId);
        return;
    }
    
    // Create and show confirmation modal
    const confirmationModal = document.createElement('div');
    confirmationModal.className = 'modal request-confirmation-modal';
    confirmationModal.id = 'requestConfirmationModal';
    
    // Get tomorrow's date as minimum pickup date
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    const minDate = tomorrow.toISOString().split('T')[0];
    
    confirmationModal.innerHTML = `
        <div class="modal-content confirmation-content">
            <div class="modal-header">
                <div class="modal-title">Confirm Food Request</div>
                <span class="close-modal" onclick="closeRequestConfirmation()">&times;</span>
            </div>
            <div class="modal-body">
                <p>You are about to request the following food donation:</p>
                <h3>${donation.title}</h3>
                <p><strong>Donor:</strong> ${donation.donor_name}</p>
                <p><strong>Pickup Address:</strong> ${donation.pickup_address}</p>
                <p><strong>Contact:</strong> ${donation.contact_email}</p>
                ${donation.contact_phone ? `<p><strong>Phone:</strong> ${donation.contact_phone}</p>` : ''}
                <div class="request-form">
                    <label for="pickupDate">Preferred Pickup Date:</label>
                    <input type="date" id="pickupDate" min="${minDate}" required />
                    
                    <label for="pickupAddress">Your Pickup Address:</label>
                    <textarea id="pickupAddress" placeholder="Enter your address or pickup location..." required></textarea>
                    
                    <label for="requestMessage">Message to donor (optional):</label>
                    <textarea id="requestMessage" placeholder="Let the donor know any special requirements or additional information..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel-btn" onclick="closeRequestConfirmation()">Cancel</button>
                <button class="confirm-request-btn" onclick="submitFoodRequestWithDetails('${donationId}')">Send Request</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(confirmationModal);
    confirmationModal.style.display = 'block';
}


// Close request confirmation modal
function closeRequestConfirmation() {
    const modal = document.getElementById('requestConfirmationModal');
    if (modal) {
        modal.style.display = 'none';
        document.body.removeChild(modal);
    }
}

// Submit food request
async function submitFoodRequest(donationId) {
    const donation = allDonations.find(d => d.id === donationId);
    const message = document.getElementById('requestMessage').value.trim();
    
    if (!donation) {
        alert('Donation not found');
        return;
    }
    
    // Get current user info
    if (!currentUser) {
        alert('Please log in to make a request');
        return;
    }
    
    try {
        // Prepare request data
        const requestData = {
            donation_id: donationId,
            requester_name: currentUser.full_name,
            requester_email: currentUser.email,
            requester_phone: currentUser.phone || null,
            pickup_date: new Date().toISOString().split('T')[0], // Today's date, you may want to add a date picker
            pickup_address: donation.pickup_address, // Using donation's pickup address, modify as needed
            message: message || null
        };
        
        // Send request to backend
        const response = await apiCall(`${API_BASE_URL}/api/requests/`, {
            method: 'POST',
            body: JSON.stringify(requestData)
        });
        
        // Close the confirmation modal
        closeRequestConfirmation();
        
        // Show success message
        showNotification('Request sent successfully! The donor will be notified.', 'success');
        
    } catch (error) {
        console.error('Error submitting request:', error);
        
        // Handle specific error cases
        if (error.message.includes('already requested')) {
            showNotification('You have already requested this donation.', 'error');
        } else if (error.message.includes('your own donation')) {
            showNotification('You cannot request your own donation.', 'error');
        } else {
            showNotification('Failed to submit request: ' + error.message, 'error');
        }
    }
}

// Create pagination
function createPagination(totalItems) {
    const pagination = document.getElementById('pagination');
    const totalPages = Math.ceil(totalItems / itemsPerPage);
    
    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }
    
    let paginationHTML = '';
    
    // Previous button
    if (currentPage > 1) {
        paginationHTML += `<button class="pagination-btn" onclick="changePage(${currentPage - 1})">
            <i class="fas fa-chevron-left"></i> Previous
        </button>`;
    }
    
    // Page numbers
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    if (startPage > 1) {
        paginationHTML += `<button class="pagination-btn" onclick="changePage(1)">1</button>`;
        if (startPage > 2) {
            paginationHTML += `<span class="pagination-ellipsis">...</span>`;
        }
    }
    
    for (let i = startPage; i <= endPage; i++) {
        paginationHTML += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
    }
    
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            paginationHTML += `<span class="pagination-ellipsis">...</span>`;
        }
        paginationHTML += `<button class="pagination-btn" onclick="changePage(${totalPages})">${totalPages}</button>`;
    }
    
    // Next button
    if (currentPage < totalPages) {
        paginationHTML += `<button class="pagination-btn" onclick="changePage(${currentPage + 1})">
            Next <i class="fas fa-chevron-right"></i>
        </button>`;
    }
    
    pagination.innerHTML = paginationHTML;
}

async function submitFoodRequestWithDetails(donationId) {
    const donation = allDonations.find(d => d.id === donationId);
    const message = document.getElementById('requestMessage').value.trim();
    const pickupDate = document.getElementById('pickupDate').value;
    const pickupAddress = document.getElementById('pickupAddress').value.trim();
    
    if (!donation) {
        alert('Donation not found');
        return;
    }
    
    if (!pickupDate) {
        alert('Please select a pickup date');
        return;
    }
    
    if (!pickupAddress) {
        alert('Please enter your pickup address');
        return;
    }
    
    // Get current user info
    if (!currentUser) {
        alert('Please log in to make a request');
        return;
    }
    
    try {
        // Prepare request data
        const requestData = {
            donation_id: donationId,
            requester_name: currentUser.full_name,
            requester_email: currentUser.email,
            requester_phone: currentUser.phone || null,
            pickup_date: pickupDate,
            pickup_address: pickupAddress,
            message: message || null
        };
        
        // Send request to backend
        const response = await apiCall(`${API_BASE_URL}/api/requests/`, {
            method: 'POST',
            body: JSON.stringify(requestData)
        });
        
        // Close the confirmation modal
        closeRequestConfirmation();
        
        // Show success message
        showNotification('Request sent successfully! The donor will be notified.', 'success');
        
    } catch (error) {
        console.error('Error submitting request:', error);
        
        // Handle specific error cases
        if (error.message.includes('already requested')) {
            showNotification('You have already requested this donation.', 'error');
        } else if (error.message.includes('your own donation')) {
            showNotification('You cannot request your own donation.', 'error');
        } else {
            showNotification('Failed to submit request: ' + error.message, 'error');
        }
    }
}

// Change page function
function changePage(page) {
    currentPage = page;
    filterAndDisplayDonations();
    
    // Scroll to top of food listings
    document.getElementById('foodListings').scrollIntoView({ behavior: 'smooth' });
}

// Auto-refresh donations every 30 seconds
setInterval(() => {
    if (isAuthenticated()) {
        loadFoodDonations();
    }
}, 30000);

// Handle click outside modal to close
window.onclick = function(event) {
    const foodModal = document.getElementById('foodModal');
    const loginModal = document.getElementById('loginModal');
    const requestModal = document.getElementById('requestConfirmationModal');
    
    if (event.target === foodModal) {
        closeModal();
    }
    if (event.target === loginModal) {
        // Don't close login modal by clicking outside
    }
    if (event.target === requestModal) {
        closeRequestConfirmation();
    }
}

// Handle escape key to close modals
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeModal();
        closeRequestConfirmation();
    }
});

// Sidebar dropdown functionality
document.addEventListener('DOMContentLoaded', function() {
    // Handle dropdown toggles
    document.querySelectorAll('.dropdown-toggle').forEach(toggle => {
        toggle.addEventListener('click', function(e) {
            e.preventDefault();
            const dropdown = this.parentElement;
            dropdown.classList.toggle('active');
            
            // Close other dropdowns
            document.querySelectorAll('.dropdown').forEach(other => {
                if (other !== dropdown) {
                    other.classList.remove('active');
                }
            });
        });
    });
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.dropdown')) {
            document.querySelectorAll('.dropdown').forEach(dropdown => {
                dropdown.classList.remove('active');
            });
        }
    });
});

// Update notification badge
function updateNotificationBadge() {
    // This would typically fetch notification count from your backend
    // For now, we'll simulate it
    const badge = document.getElementById('notificationBadge');
    if (badge) {
        // You can implement actual notification logic here
        badge.textContent = '0';
        if (badge.textContent === '0') {
            badge.style.display = 'none';
        }
    }
}

// Initialize notification badge
updateNotificationBadge();

// Format time helper function
function formatTimeFromDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleTimeString('en-US', {
        hour: 'numeric',
        minute: '2-digit',
        hour12: true
    });
}

// Calculate relative time helper function
function getRelativeTime(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMins / 60);
    const diffDays = Math.floor(diffHours / 24);
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins} minutes ago`;
    if (diffHours < 24) return `${diffHours} hours ago`;
    if (diffDays < 7) return `${diffDays} days ago`;
    
    return date.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined
    });
}

// Enhanced error handling for image loading
function handleImageError(img) {
    const placeholder = document.createElement('div');
    placeholder.className = 'no-image';
    placeholder.innerHTML = '<i class="fas fa-utensils"></i>';
    img.parentElement.replaceChild(placeholder, img);
}

// Add loading states for better UX
function showCardLoading() {
    const foodListings = document.getElementById('foodListings');
    foodListings.innerHTML = '';
    
    // Create skeleton cards
    for (let i = 0; i < 6; i++) {
        const skeletonCard = document.createElement('div');
        skeletonCard.className = 'food-card skeleton';
        skeletonCard.innerHTML = `
            <div class="skeleton-image"></div>
            <div class="skeleton-content">
                <div class="skeleton-title"></div>
                <div class="skeleton-text"></div>
                <div class="skeleton-text short"></div>
                <div class="skeleton-button"></div>
            </div>
        `;
        foodListings.appendChild(skeletonCard);
    }
}

// Enhanced search functionality with debouncing
let searchTimeout;
document.getElementById('search-input').addEventListener('input', function() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        filterAndDisplayDonations();
    }, 300); // Debounce search by 300ms
});

// Export functions for potential external use
window.foodDonationApp = {
    loadFoodDonations,
    filterAndDisplayDonations,
    openDonationDetails,
    closeModal,
    deleteDonation,
    showRequestConfirmation,
    submitFoodRequest,
    logout,
    performLogin
};

</script>
